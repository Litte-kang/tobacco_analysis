        <div class="col-sm-3 col-md-2 sidebar">
          <ul class="nav nav-sidebar">
            <li><a href="/workflows/manage_fresh">鲜烟素质分析 <span class="sr-only">(current)</span></a></li>
            <li><a href="/workflows/fresh_tobacco/packings">装烟情况统计</a></li>
            <li><a href="/workflows/dry_tobacco">烘烤量统计</a></li>
            <li><a href="#">烤房使用情况统计</a></li>
            <li><a href="/alarms">烤房远程监管</a></li>
          </ul>          
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <h1 class="page-header">Analysis</h1>
          <h4>永州市-江华县-白芒营镇-云田工场</h4>
          <div class="row placeholders">
            <div class="col-xs-12 col-sm-12 col-md-12">
                        <div role="tabpanel">

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
              <li role="presentation" class="active"><a href="/workflows/fresh_tobacco" aria-controls="home" role="tab" data-toggle="link">鲜烟成熟度分析</a></li>
              <li role="presentation"><a href="/workflows/fresh_tobacco/breeds" aria-controls="profile" role="tab" data-toggle="link">鲜烟品种统计</a></li>
              <li role="presentation"><a href="/workflows/fresh_tobacco/fresh_type" aria-controls="messages" role="tab" data-toggle="link">鲜烟类型分析</a></li>
              <li role="presentation"><a href="#settings" aria-controls="settings" role="tab" data-toggle="link">干烟质量分析</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane active" id="home">
                <div class="row">
                  <div class="col-xs-6 col-sm-4">
                    <div class="radio">
                      <label class="radio-inline">
                        <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"> 按烤房统计
                      </label>
                      <label class="radio-inline">
                        <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2"> 按大户统计
                      </label>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-2"><input type="text" class="form-control" placeholder="烤房编号"></div>
                  <div class="col-xs-2"><input type="text" class="form-control" placeholder="烟基编号"></div>
                  <div class="col-xs-3">
                      <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">开始日期</div>
                            <input type="text" class="form-control" id="exampleInputAmount" name="startDate" />
                        </div>
                      </div> 
                  </div>
                  <div class="col-xs-3">
                      <div class="form-group">
                        <div class="input-group">
                            <div class="input-group-addon">结束日期</div>
                            <input type="text" class="form-control" id="exampleInputAmount" name="endDate" />
                        </div>
                      </div> 
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-2"><input type="text" class="form-control" placeholder="鲜烟品种"></div>
                  <div class="col-xs-2"><input type="text" class="form-control" placeholder="鲜烟部位"></div>
                  <div class="col-xs-2"><button type="button" class="btn btn-primary">搜索</button></div>
                  <div class="col-xs-2"><button type="button" class="btn btn-default">重置</button></div>
                </div>
              </div>
              <div role="tabpanel" class="tab-pane" id="profile">...</div>
              <div role="tabpanel" class="tab-pane" id="messages">...</div>
              <div role="tabpanel" class="tab-pane" id="settings">...</div>
            </div>
        </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xs-2">
              <button class="btn btn-default" type="submit" id="show_chart">显示图表</button>
            </div>
          </div>
           <div class="row">
            <canvas id="myChart" height="400" width="947" style="display: none"></canvas>
          </div>
          <h4 class="sub-header">烘烤鲜烟质成熟度查询表</h4>
          <h6>单位：公斤</h6>
          <div class="table-responsive">
            <table id="fresh_table" class="display" cellspacing="0" width="100%">
              <thead>
                <tr>
                  <th rowspan="2">烤房编号</th>
                  <th rowspan="2">烟基编号</th>
                  <th rowspan="2">鲜烟总量</th>
                  <th rowspan="2">坎数</th>
                  <th rowspan="2">品种</th>               
                  <th rowspan="2">部位</th>
                  <th rowspan="2">类型</th>
                  <th rowspan="2">质地</th>
                  <th colspan="3">成熟度</th>
                  <th rowspan="2">照片</th>
                  <th rowspan="2">日期</th>
                </tr>
                <tr>
                  <th>正常烟叶</th>
                  <th>欠熟烟叶</th>
                  <th>过熟烟叶</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
      <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
      
            </div>
        </div>
      </div>

      <script type="text/javascript">
        $(document).ready(function(){
            var table = $('#fresh_table').dataTable({
              "scrollCollapse": true
            });

            var freshTobaccos = [];
            
            $.getJSON('http://121.41.111.212:1337/workflows/manage_fresh/tobaccos', function(data){

              var arr = data.result;
              if(arr.length > 0){
                table.api().rows.add(createTobacco(arr)).draw();
              } 
            });

            function createTobacco(arr){
                var freshTobaccos = [];
                

                arr.forEach(function(element, index, arr){
                  var tobacco = [];
                  var count = 1;
                  var amount_weight = parseFloat(element.packing.average_weight) *
                                      parseInt(element.packing.packing_amount) / 2;

                  tobacco.push(element.room_no);
                  tobacco.push(element.tobacco_no);
                  tobacco.push(amount_weight.toFixed(2));

                  //统计坎数
                  freshTobaccos.forEach(function(ele, index, freshTobaccos){
                      if(ele[1] == element.tobacco_no)
                        count ++;
                  });
                  tobacco.push(count);

                  tobacco.push(element.fresh_tobacco.breed);
                  tobacco.push(element.fresh_tobacco.part);
                  tobacco.push(element.fresh_tobacco.tobacco_type);
                  tobacco.push(element.fresh_tobacco.quality);

                  var maturities = element.fresh_tobacco.maturity.split('/');
                  maturities.forEach(function(m, i, maturities){
                    tobacco.push((parseFloat(m) / 100 * amount_weight).toFixed(2));
                  });

                  var files = element.fresh_tobacco.filename;
                  var paths = '';
                  files.forEach(function(file, index, files){
                      paths += '<a href="/images/photos/'+ file +'" target="_blank"><img src="/images/photos.jpg" width="20" height="20" /></a>'
                  });
                  tobacco.push(paths);

                  tobacco.push(element.protocol_created_at.slice(0,element.protocol_created_at.indexOf('T')));
                  freshTobaccos.push(tobacco);

                });
                return freshTobaccos;
            }

            var chart;
            $('#show_chart').on('click', function(){
              $('#myChart').show();  

              chart = initChart();
              chart.Pie(prepairDatasets(table), chartOpts);
            });

            function initChart(){
              var ctx = $("#myChart").get(0).getContext("2d");
              return new Chart(ctx);
            }

            function prepairDatasets(dataTable){
              // var packingAmount = dataTable.api().columns(2).data().reduce(function (a,b) {
              //   return a + b;
              // });

              var normal = 0;
              var normals = dataTable.api().columns(8).data().reduce(function(a, b){
                return a + b;
              });

              normals.forEach(function(value, index){
                normal += parseFloat(value);
              })

              var qianshu = 0;
              dataTable.api().columns(9).data().reduce(function(a, b){
                  return a + b;
              }).forEach(function(value, index){
                qianshu += parseFloat(value);
              });

              var guoshu = 0;
              dataTable.api().columns(10).data().reduce(function(a, b){
                  return a + b;
              }).forEach(function(value ,index){
                guoshu += parseFloat(value);
              });

             console.log( guoshu)
              var data = [
                {value: normal.toFixed(2), color:"#F7464A", highlight: "#FF5A5E", label: "正常烟叶"},
                {value: qianshu.toFixed(2), color:"#46BFBD", highlight: "#5AD3D1", label: "欠熟烟叶"},
                {value: guoshu.toFixed(2), color:"#FDB45C", highlight: "#FFC870", label: "过熟烟叶"}
              ];
              return data;
            }

                var chartOpts = {

        ///Boolean - Whether grid lines are shown across the chart
        scaleShowGridLines : true,

        //String - Colour of the grid lines
        scaleGridLineColor : "rgba(0,0,0,.05)",

        //Number - Width of the grid lines
        scaleGridLineWidth : 1,

        //Boolean - Whether to show horizontal lines (except X axis)
        scaleShowHorizontalLines: true,

        //Boolean - Whether to show vertical lines (except Y axis)
        scaleShowVerticalLines: true,

        //Boolean - Whether the line is curved between points
        bezierCurve : false,

        //Number - Tension of the bezier curve between points
        bezierCurveTension : 0.4,

        //Boolean - Whether to show a dot for each point
        pointDot : true,

        //Number - Radius of each point dot in pixels
        pointDotRadius : 4,

        //Number - Pixel width of point dot stroke
        pointDotStrokeWidth : 1,

        //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
        pointHitDetectionRadius : 20,

        //Boolean - Whether to show a stroke for datasets
        datasetStroke : true,

        //Number - Pixel width of dataset stroke
        datasetStrokeWidth : 2,

        //Boolean - Whether to fill the dataset with a colour
        datasetFill : true
      };
        });
      </script>
